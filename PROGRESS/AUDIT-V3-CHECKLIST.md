# قائمة تحقق ضوابط التدقيق — النظام الحالي ونسخة v3

هذا الملف قائمة تحقق لضمان نقل ضوابط التدقيق والموافقات والصلاحيات عند اكتمال النقل إلى v3.

---

## ضوابط المراجعة في النظام الحالي (Backend الحالي)

| البند | الحالة | ملاحظة |
|-------|--------|--------|
| سجل التدقيق (audit_logs) | مُنفّذ | خدمة audit + مسارات GET /api/audit، تصدير، إحصائيات |
| تسجيل عمليات الفواتير في التدقيق | مُنفّذ | إنشاء، تعديل، إلغاء، حذف، طلب موافقة |
| موافقات إلغاء/حذف الفواتير | مُنفّذ | POST /cancel يُنشئ طلب موافقة؛ DELETE يُوجّه لطلب حذف أو تجاوز |
| صلاحيات الفواتير (sales/purchases.invoice.*) | مُنفّذ | عرض، إنشاء، تعديل، إلغاء، حذف، طباعة حسب نوع الفاتورة |
| ضوابط الكميات في التطبيق | جزئي | protectQuantityChange في device؛ باقي المسارات حسب الحاجة |
| حماية البيانات الحساسة | مُنفّذ | إخفاء حقول، تسجيل وصول، تشفير |
| تجاوز الموافقات (bypass) | مُنفّذ | cancel-now، force delete للمخوّلين + تسجيل bypass في التدقيق |

---

## قائمة مقابلة لنسخة v3

عند نقل كل ميزة إلى v3 (PostgreSQL + Hono + React)، التأكد من:

| البند | أولوية | التحقق |
|-------|--------|--------|
| سجل التدقيق | أولى | وجود جدول audit_logs وواجهة API للبحث والتصدير |
| تسجيل أحداث الفواتير | أولى | كل عملية فاتورة (إنشاء، تعديل، إلغاء، حذف) تُسجّل في التدقيق |
| نظام الموافقات | أولى | جداول approvals، طلب إلغاء فاتورة، طلب حذف، تنفيذ عند الموافقة |
| صلاحيات الفواتير | أولى | نفس مصفوفة الصلاحيات (sales.invoice.*, purchases.invoice.*) على المسارات |
| إخفاء التكلفة حسب الدور | أولى | عرض سعر الشراء/الأرباح للمالك فقط أو من لديه view_cost |
| ضوابط الكميات | ثانية | تطبيق في التطبيق أو عبر Triggers في PostgreSQL |
| تجاوز الموافقات | ثانية | مسارات cancel-now / force مع صلاحية bypass وتسجيل التدقيق |

---

## أولويات النقل

- **المرحلة الأولى أو الثانية** من نقل الـ API إلى v3 يجب أن تشمل:
  - التدقيق (سجل + تسجيل أحداث الفواتير).
  - الموافقات (طلبات إلغاء/حذف فواتير + اعتماد/رفض).
  - صلاحيات الفواتير (ربط المسارات بصلاحيات المصفوفة).

- الاحتفاظ بهذه القائمة محدثة عند إكمال كل بند في v3.
