# تقرير لجنة تدقيق الحسابات
## نظام BI Smart Management — مراجعة أنظمة الرقابة والمالية

**تاريخ التقرير:** 6 فبراير 2026  
**نطاق المراجعة:** البرنامج كمنظومة إدارة شركات (Backend، Frontend، قاعدة البيانات، الأمان، التدقيق)

---

## ١. الملخص التنفيذي

تمت مراجعة نظام **BI Smart Management** من منظور لجنة تدقيق حسابات من حيث:
- ضوابط الرقابة الداخلية والتدقيق
- حماية البيانات المالية والحساسة
- تتبع العمليات وسجل التدقيق
- فصل الصلاحيات والصلاحيات المالية
- مخاطر الاحتيال والخطأ

**الرأي الإجمالي:** النظام يمتلك **أساساً قوياً** من ناحية التصميم (سجل تدقيق، صلاحيات، حماية بيانات حساسة، فصل أدوار)، وتوجد وثائق تخطيط جيدة لنظام الأمان والتدقيق. لكن توجد **ثغرات تنفيذية** يجب معالجتها قبل الاعتماد الكامل من جهة تدقيق خارجية، أبرزها: عدم تسجيل أحداث الفواتير (إنشاء/تعديل/إلغاء) في سجل التدقيق، وعدم ربط مسارات الفواتير بنظام الموافقات والصلاحيات التفصيلية.

---

## ٢. نطاق ومنهجية المراجعة

| البند | التفاصيل |
|-------|----------|
| **المادة المراجعة** | كود المصدر (Backend، Database، Planning)، وثائق الأمان والتدقيق، سكربتات التحليل المالي |
| **المعايير المرجعية** | أفضل الممارسات في الرقابة الداخلية، فصل الواجبات، سجل التدقيق، حماية البيانات الحساسة |
| **الأدوات** | مراجعة الكود، تتبع المسارات (Routes)، فحص الـ Middleware والـ Services |

---

## ٣. نقاط القوة (إيجابيات)

### ٣.١ نظام سجل التدقيق (Audit Log)

- **موجود ومُطبّق** في الـ Backend: خدمة `audit.service.js` تسجل أحداثاً متعددة (دخول، خروج، صلاحيات، أجهزة، تحويلات).
- **فئات أحداث واضحة:** AUTH، INVENTORY، INVOICE، WARRANTY، SENSITIVE، APPROVAL، SYSTEM، SECURITY.
- **مستويات خطورة:** info، warning، critical مع إشعار المالك للأحداث الحرجة.
- **واجهة API للتدقيق:** `GET /api/audit` مع فلاتر (تاريخ، مستخدم، نوع حدث)، تصدير، وإحصائيات.
- **حماية السجل:** عدم السماح بحذف أو تعديل سجلات التدقيق (مذكور في الاختبارات).
- **تنظيف تلقائي:** حذف السجلات القديمة (مثلاً أكثر من 90 يوم) مع الاحتفاظ بالحرجة في الـ Scheduler.

**التقييم:** يتوافق مع متطلبات تدقيق حسابات من حيث وجود سجل تدقيق مركزي وقابل للاستعلام.

---

### ٣.٢ الصلاحيات والأدوار

- **743 صلاحية** منفصلة و**12 دوراً** (super_admin، owner، admin، accountant، salesperson، warehouse_keeper، ...).
- **فصل واضح:** المالك يرى سعر الشراء والأرباح؛ المحاسب والمخزن والمبيعات لا يرونها (موثق في DATABASE-ANALYSIS و SECURITY-AND-AUDIT-SYSTEM).
- **جدول الأدوار والصلاحيات** في قاعدة البيانات مع دعم صلاحيات مخصصة للمستخدم.
- **التحقق من الصلاحية** قبل الوصول لسجل التدقيق (`requirePermission('audit.read')`، `audit.export`).

**التقييم:** يلبي مبدأ فصل الواجبات وتقييد الوصول للبيانات الحساسة.

---

### ٣.٣ حماية البيانات الحساسة

- **تشفير حقول حساسة:** `cost_price_encrypted`، `purchase_cost_encrypted` في جداول المنتجات والأجهزة.
- **Middleware للبيانات الحساسة:** `sensitiveData.js` يخفي الحقول حسب مستوى المستخدم (رواتب، حسابات بنكية، هوية، إلخ).
- **تسجيل الوصول للبيانات الحساسة:** عند الوصول أو الرفض يتم التسجيل في سجل التدقيق.
- **قائمة أحداث حرجة** تُبلغ المالك (عرض سعر الشراء، تصدير بيانات، طلبات حذف، إلخ).

**التقييم:** متوافق مع متطلبات سرية البيانات المالية ومتابعة الوصول لها.

---

### ٣.٤ التصميم المخطط (الوثائق)

- **SECURITY-AND-AUDIT-SYSTEM.md:** يصف سجل التدقيق، حماية الحذف، حماية الكميات، الموافقات، تتبع الضمان، أرشفة المنتجات.
- **جداول موثقة:** `audit_logs`، `deletion_requests`، `quantity_adjustments`، `approvals`، `warranty_claims`.
- **منع التعديل المباشر للكميات** عبر Triggers (في الوثيقة) يقلل مخاطر التلاعب بالمخزون.

**التقييم:** التصميم يظهر وعياً بمتطلبات التدقيق والرقابة الداخلية.

---

### ٣.٥ البنية التقنية والمالية

- **87 جدولاً** يغطي المبيعات، المشتريات، المخزون، الحسابات، القيود، الشيكات، الموارد البشرية، الضمان، إلخ.
- **سكربتات تحليل مالية** (مثل `analyze-financials.py`) لتحليل الفواتير والمبيعات والمشتريات من بيانات التصدير.
- **نسخ احتياطي:** وجود مسارات وخدمات للنسخ الاحتياطي والاستعادة.

**التقييم:** النظام مصمم لدعم دورة مالية ومخزنية كاملة وقابل للتحقق منه عبر تقارير خارجية.

---

## ٤. الملاحظات والتوصيات (ثغرات ومخاطر)

### ٤.١ [مهم] عدم تسجيل عمليات الفواتير في سجل التدقيق

- **الملاحظة:** مسارات الفواتير (`invoice.routes.js`) تستخدم `auth` فقط ولا تستدعي `audit.service` أو `auditMiddleware`.
- **العمليات غير المسجلة حالياً:** إنشاء فاتورة، تعديل فاتورة، إلغاء فاتورة، حذف (soft delete) فاتورة، تسجيل دفعة/تحديث حالة الدفع.
- **المخاطر:** عدم إمكانية تتبع من قام بإلغاء أو تعديل فاتورة، أو تغيير المبالغ، مما يضعف المراجعة والمساءلة.

**التوصية:**  
- ربط كل من: `POST /api/invoices`، `PUT /api/invoices/:id`، `POST /api/invoices/:id/cancel`، `DELETE /api/invoices/:id` بتسجيل في `audit_logs` (نوع الحدث، المستخدم، القيم القديمة/الجديدة، السبب عند الإلغاء).  
- استخدام `auditMiddleware` أو استدعاء صريح لـ `auditService.log()` مع `entity_type: 'invoice'`.

---

### ٤.٢ [مهم] إلغاء وحذف الفواتير بدون موافقة مسبقة

- **الملاحظة:** إلغاء الفاتورة (`POST .../cancel`) وحذفها (`DELETE .../:id`) يعملان مباشرة بدون المرور بجدول `approvals` أو `deletion_requests` كما في التصميم (SECURITY-AND-AUDIT-SYSTEM).
- **المخاطر:** إمكانية إلغاء أو “حذف” فواتير بدون رقابة ثانية، مما يزيد مخاطر الاحتيال أو إخفاء المعاملات.

**التوصية:**  
- تطبيق نفس منطق “طلبات الحذف والموافقة” على إلغاء الفواتير: إنشاء طلب موافقة (أو سجل في `deletion_requests`) وربطه بالفاتورة، وإلغاء الفاتورة فعلياً فقط بعد موافقة دور مخوّل (مثل owner/admin).  
- تسجيل كل من طلب الإلغاء والموافقة/الرفض في سجل التدقيق.

---

### ٤.٣ التحقق من الصلاحيات على مسارات الفواتير

- **الملاحظة:** مسارات الفواتير محمية بـ `auth` فقط، دون `requirePermission` أو صلاحيات محددة (مثل `invoice.create`، `invoice.update`، `invoice.cancel`، `invoice.delete`).
- **المخاطر:** أي مستخدم مسجل دخوله يمكنه إنشاء/تعديل/إلغاء فواتير إذا لم تُطبّق الصلاحيات في طبقة أخرى.

**التوصية:**  
- إضافة التحقق من الصلاحيات على كل عملية فاتورة (إنشاء، تعديل، إلغاء، حذف، طباعة) وفق مصفوفة الصلاحيات (743 صلاحية).  
- التأكد من أن صلاحيات مثل عرض سعر الشراء أو الأرباح على مستوى الفاتورة تبقى مقيدة بالدور (مثل owner).

---

### ٤.٤ التطابق بين التصميم (PostgreSQL) والتنفيذ (SQLite)

- **الملاحظة:** وثيقة SECURITY-AND-AUDIT-SYSTEM تعتمد بناء جملة PostgreSQL (مثل `gen_random_uuid()`، `JSONB`، Triggers). الـ Backend الحالي يعمل مع SQLite (`audit.service` يستخدم `run`/`get`/`all` من `database.js`).
- **المخاطر:** عدم تطبيق بعض الضوابط المعتمدة على Triggers (مثل منع التعديل المباشر للكميات) إذا لم تُنقل أو تُعاد كتابتها لـ SQLite.

**التوصية:**  
- توثيق أي اختلافات بين بيئة التطوير/الإنتاج (SQLite vs PostgreSQL).  
- في حال البقاء على SQLite: تنفيذ منطق “منع التعديل المباشر للكميات” في طبقة التطبيق (مثلاً في الخدمات أو الـ API) حتى يتم توحيد القاعدة لاحقاً.

---

### ٤.٥ نسخة v3 والنقل غير المكتمل

- **الملاحظة:** FEATURES-STATUS يوضح أن نسخة v3 (PostgreSQL + Hono + React) لديها جزء منقول فقط (مثلاً ~18 مسار API)، بينما النظام القديم يحتوي 160+ endpoint و 850+ ميزة.
- **المخاطر:** اعتماد تدقيق على النظام الحالي (القديم) بينما خطة الترحيل قد تغير البيئة لاحقاً؛ وعدم اكتمال النقل قد يترك فجوات في الرقابة إذا لم تُنسخ ضوابط التدقيق والصلاحيات بالكامل.

**التوصية:**  
- عند استكمال النقل إلى v3، جعل “التدقيق والموافقات وصلاحيات الفواتير” ضمن أولويات النقل.  
- الاحتفاظ بقائمة تحقق (checklist) للضوابط المراجعة في كلا النسختين حتى اكتمال الترحيل.

---

### ٤.٦ سكربتات التحليل المالية ومسار البيانات

- **الملاحظة:** سكربتات مثل `analyze-financials.py` تعتمد على مجلد تصدير ثابت (`data/morabaa-export`) وملفات JSON.
- **المخاطر:** إذا استُخدمت هذه السكربتات لأغراض قرارات أو تقارير رسمية، يجب التأكد من أن مصدر البيانات (Morabaa/التصدير) معتمد ومُحدّث وأن السكربتات لا تعدّل البيانات الأصلية.

**التوصية:**  
- توثيق أن مصدر البيانات للتحليل هو “نسخة تصدير للقراءة فقط” وعدم استخدامها كأساس وحيد للمراجعة دون التطابق مع النظام الأساسي عند الحاجة.  
- لأغراض التدقيق، إمكانية إنتاج تقارير مماثلة من قاعدة البيانات الرسمية (Backend API أو تقارير مدمجة).

---

## ٥. خلاصة التقييم حسب المحاور

| المحور | التقييم | ملاحظة مختصرة |
|--------|---------|----------------|
| **سجل التدقيق** | جيد مع ثغرات | الخدمة والـ API موجودان؛ عمليات الفواتير غير مسجلة. |
| **الصلاحيات والأدوار** | جيد | 743 صلاحية و12 دوراً؛ تحتاج ربطاً صريحاً بمسارات الفواتير. |
| **حماية البيانات الحساسة** | جيد | تشفير وإخفاء وتسجيل وصول؛ متوافق مع متطلبات التدقيق. |
| **الموافقات والحذف** | ضعيف في التنفيذ | التصميم ممتاز؛ تطبيق الموافقات على إلغاء/حذف الفواتير ناقص. |
| **البنية المالية والمخزنية** | جيد | جداول وشجرة حسابات وقيود؛ كافٍ لدورة مالية قابلة للمراجعة. |
| **الاختبارات** | جيد | وجود اختبارات أمان وتدقيق وAPI؛ يُفضّل إضافة حالات لفواتير وتدقيق. |

---

## ٦. الخلاصة والرأي النهائي

- **نظام BI Smart Management** يمتلك **تصميماً قوياً** من ناحية الرقابة الداخلية وسجل التدقيق والصلاحيات وحماية البيانات الحساسة، وهو **قابل لأن يكون أساساً جيداً** لبيئة تخضع لتدقيق حسابات بعد معالجة الثغرات المذكورة.
- **أهم نقاط التحسين:** (1) تسجيل كل عمليات الفواتير (إنشاء، تعديل، إلغاء، حذف) في سجل التدقيق، (2) ربط إلغاء وحذف الفواتير بنظام الموافقات، (3) تطبيق صلاحيات تفصيلية على مسارات الفواتير.
- بعد تنفيذ التوصيات أعلاه، يُوصى بإعادة مراجعة مختصرة من لجنة التدقيق للتأكد من اكتمال الضوابط قبل أي تدقيق خارجي أو اعتماد نظامي.

---

*تم إعداد هذا التقرير بصفة مراجعة لأنظمة الرقابة والبرنامج من منظور لجنة تدقيق حسابات، وليس بديلاً عن تدقيق مالي أو قانوني من جهة مستقلة.*
